FROM java:8-jdk
MAINTAINER Hendrik Saly (codecentric AG)
ENV REFRESHED_AT 2017-04-17

###############################################################################
#                                INSTALLATION
###############################################################################

### install Elasticsearch

RUN echo 'debconf debconf/frontend select Noninteractive' | debconf-set-selections
RUN apt-get update -qq \
 && apt-get install -qqy apt-utils curl net-tools

RUN curl -s http://packages.elasticsearch.org/GPG-KEY-elasticsearch | apt-key add -
RUN echo "deb http://packages.elasticsearch.org/elasticsearch/2.x/debian stable main" | tee -a /etc/apt/sources.list
RUN echo "deb http://packages.elastic.co/beats/apt stable main" | tee -a /etc/apt/sources.list

RUN apt-get update -qq \
 && apt-get install -qqy \
		elasticsearch=2.3.1 topbeat \
 && apt-get clean

### install plugins
RUN /usr/share/elasticsearch/bin/plugin install license
RUN /usr/share/elasticsearch/bin/plugin install graph
RUN /usr/share/elasticsearch/bin/plugin install marvel-agent
RUN /usr/share/elasticsearch/bin/plugin install lmenezes/elasticsearch-kopf/2.1.2

###############################################################################
#                               CONFIGURATION
###############################################################################

### configure Elasticsearch

ADD ./elasticsearch.yml /etc/elasticsearch/elasticsearch.yml
###############################################################################
#                                   START
###############################################################################

ADD ./start2ndNode.sh /usr/local/bin/start2ndNode.sh
RUN chmod +x /usr/local/bin/start2ndNode.sh

EXPOSE 9201 9301
VOLUME /var/lib/elasticsearch
ADD snapshot /snapshot

CMD [ "/usr/local/bin/start2ndNode.sh" ]
